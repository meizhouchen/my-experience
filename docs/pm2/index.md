# pm2
[PM2ä¸­æ–‡ç½‘](https://pm2.fenxianglu.cn/docs/start)
pm2æ˜¯nodeè¿›ç¨‹ç®¡ç†å·¥å…·ã€‚

## ç‰¹æ€§
1ã€åå°è¿è¡Œ
æ™®é€šå¯åŠ¨æ–¹å¼ï¼šnode index.jsï¼Œå…³é—­ç»ˆç«¯å°±ç»“æŸè¿›ç¨‹ï¼›
pm2å¯ä»¥åå°è¿è¡Œï¼Œç»ˆç«¯å…³é—­ä¸å½±å“ã€‚

2ã€è‡ªåŠ¨é‡å¯
å¯ä»¥ç›‘å¬æŸäº›æ–‡ä»¶æ”¹åŠ¨ï¼Œè‡ªåŠ¨é‡å¯

3ã€åœæ­¢ä¸ç¨³å®šçš„è¿›ç¨‹
é™åˆ¶ä¸ç¨³å®šçš„é‡å¯çš„æ¬¡æ•°ï¼Œè¾¾åˆ°ä¸Šé™å°±åœæ­¢è¿›ç¨‹ã€‚

4ã€0 ç§’åœæœºé‡å¯
é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œå¯ä»¥è¾¾åˆ°é‡å¯æ—¶ä¸åœæ­¢æœåŠ¡ã€‚

5ã€ç®€å•æ—¥å¿—ç®¡ç†
pm2å¯ä»¥æ”¶é›†æ—¥å¿—ï¼Œå¹¶æœ‰æ’ä»¶é…åˆè¿›è¡Œç®¡ç†ã€‚åé¢ä¼šæåˆ°ã€‚

6ã€è‡ªåŠ¨è´Ÿè½½å‡è¡¡
clusteræ¨¡å¼ä¸‹ï¼Œä¼šè‡ªåŠ¨ä½¿ç”¨è½®è¯¢çš„æ–¹å¼è¾¾åˆ°è´Ÿè½½å‡è¡¡ï¼Œä»è€Œå‡è½»æœåŠ¡å™¨çš„å‹åŠ›ã€‚

7ã€æä¾›å®æ—¶çš„æ¥å£
pm2æ’ä»¶æä¾›å®æ—¶çš„æ¥å£ï¼Œè¿”å›æœåŠ¡å™¨ä¸è¿›ç¨‹çš„ä¿¡æ¯ï¼Œåé¢ä¼šæåˆ°ã€‚

8ã€é›†æˆç®¡ç†
å¯¹äºå¤šä¸ªè¿›ç¨‹ï¼Œä¸åŒç¯å¢ƒï¼Œå¯ä»¥ç»Ÿä¸€é…ç½®ï¼Œæ–¹ä¾¿ç®¡ç†ã€‚

## å®‰è£…
```bash
npm install pm2 -g
```

æŸ¥çœ‹pm2çš„ä½ç½®
```bash
whereis pm2
```

å¦‚æœè¿™æ—¶å€™è¿˜æ˜¯æ— æ³•è¿è¡Œï¼Œå¯ä»¥å°†nodeå®‰è£…ç›®å½•é‡Œé¢çš„binç›®å½•é‡Œé¢çš„å¿«æ·æ–¹å¼ï¼Œé“¾æ¥åˆ°è¿è¡Œç›®å½•å°±å¯ä»¥äº†ï¼Œå…·ä½“æ“ä½œæ–¹æ³•ï¼š

whereis pm2

å¾—åˆ°çš„ç›®å½•å°±æ˜¯pm2æ‰€åœ¨çš„ç›®å½•ï¼Œç„¶ååŠ ä¸€ä¸ªå¿«æ·ï¼š

```bash
ln -s /usr/software/nodejs/bin/pm2 /usr/local/bin/
```


## ä½¿ç”¨
- å¯åŠ¨è¿›ç¨‹: 
```bash
pm2 start app.js
```
å¾—åˆ°å¦‚ä¸‹å›¾
![](index_files/1.jpg)
ï¼ˆ1ï¼‰å…¶ä¸­app name å’Œidéƒ½æ˜¯è¿™ä¸ªè¿›ç¨‹çš„æ ‡è¯†ï¼Œå¯ä»¥å¯¹ä»–ä»¬è¿›è¡Œåˆ«çš„æ“ä½œï¼Œæ¯”å¦‚stopï¼Œdeleteç­‰ã€‚
ï¼ˆ2ï¼‰modeï¼šè¿›ç¨‹æ¨¡å¼ï¼Œclusteræˆ–forkã€‚clusteræœ‰å¤šä¸ªè¿›ç¨‹ï¼Œè€Œforkåªæœ‰ä¸€ä¸ªã€‚
ï¼ˆ3ï¼‰statusï¼šè¿›ç¨‹æ˜¯å¦åœ¨çº¿
ï¼ˆ4ï¼‰restartï¼šé‡å¯æ¬¡æ•°
ï¼ˆ5ï¼‰uptimeï¼šè¿è¡Œæ—¶é—´
ï¼ˆ6ï¼‰cpuï¼šcpuå ç”¨ç‡
ï¼ˆ7ï¼‰memï¼šå†…å­˜å ç”¨å¤§å°

- åœæ­¢è¿›ç¨‹ï¼š
```bash
pm2 stop app_name|app_id|all
```
- åˆ é™¤è¿›ç¨‹ï¼š
```bash
pm2 delete app_name|app_id|all
```
- é‡å¯è¿›ç¨‹ï¼š
```bash
pm2 restart/reload app_name|app_id|all
```
é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œrestartä¸­æ–­æœåŠ¡ï¼Œè€Œreloadä¸ä¼š

- æŸ¥çœ‹æ‰€æœ‰çš„è¿›ç¨‹ï¼š
```bash
pm2 list/ls/status
```
idç¼–å·ä»1~4çš„æ˜¯ä¸€ä¸ªåº”ç”¨ï¼Œåˆ†åˆ«å¯¹åº”4ä¸ªè¿›ç¨‹ã€‚

- æŸ¥çœ‹æŸä¸€ä¸ªè¿›ç¨‹çš„ä¿¡æ¯ï¼š
```bash
pm2 show app_name|app_id
```
statusï¼ˆçŠ¶æ€ï¼‰ã€restartsï¼ˆé‡å¯æ¬¡æ•°ï¼‰ã€uptimeï¼ˆè¿è¡Œæ—¶é—´ï¼‰ã€script pathï¼ˆå¯åŠ¨å…¥å£çš„è·¯å¾„ï¼‰ã€script argsï¼ˆå¯åŠ¨æ–‡ä»¶çš„å‚æ•°ï¼‰ã€error log pathï¼ˆé”™è¯¯æ—¥å¿—çš„è·¯å¾„ï¼‰ã€out log pathï¼ˆè¾“å‡ºæ—¥å¿—çš„è·¯å¾„ï¼‰ã€exec modeï¼ˆè¿›ç¨‹çš„æ¨¡å¼ï¼‰ã€watch&reloadï¼ˆæ˜¯å¦å¼€å¯ç›‘å¬æ–‡ä»¶å˜åŠ¨é‡å¯ï¼‰ã€unstable restartsï¼ˆä¸ç¨³å®šçš„é‡å¯æ¬¡æ•°ï¼‰

heap sizeï¼ˆå †å†…å­˜ï¼‰ã€heap usageï¼ˆå †å†…å­˜ä½¿ç”¨ç‡ï¼‰ã€used heap sizeï¼ˆå †å†…å­˜ä½¿ç”¨æƒ…å†µï¼‰ã€event loop latencyï¼ˆäº‹ä»¶å¾ªç¯æ—¶å»¶ï¼‰ã€event loop latency p95ï¼ˆäº‹ä»¶å¾ªç¯æ—¶å»¶ ç¬¬95åˆ†ä½ï¼‰

- æŸ¥çœ‹æ—¥å¿—ï¼š
```bash
pm2 logs
```

- ç›‘æ§æ‰€æœ‰è¿›ç¨‹ï¼š
```bash
pm2 monit
```
- å¯åŠ¨å‘½ä»¤ï¼ˆstartï¼‰è¿˜å¯ä»¥å¸¦å‚æ•°
å…¶å®ƒå¯ç”¨é€‰é¡¹ï¼š

--watch ä»¥ç›‘å¬æ¨¡å¼å¯åŠ¨ï¼Œå½“æ–‡ä»¶å‘ç”Ÿå˜åŒ–æ—¶è‡ªåŠ¨é‡å¯
--max-memory-restart <200MB> è®¾ç½®åº”ç”¨é‡è½½å ç”¨çš„æœ€å¤§å†…å­˜
--log <log_path> æŒ‡å®šæ—¥å¿—æ–‡ä»¶
-- arg1 arg2 arg3 ç»™å¯åŠ¨è„šæœ¬ä¼ é€’é¢å¤–çš„å‚æ•°
--restart-delay <delay in ms> å»¶æ—¶ x æ¯«ç§’è‡ªåŠ¨é‡å¯
--time æ—¥å¿—é‡Œæ·»åŠ æ—¶é—´å‰ç¼€
--no-autorestart ä¸è‡ªåŠ¨é‡å¯
--cron <cron_pattern> æŒ‰æŒ‡å®šçš„å®šæ—¶ä»»åŠ¡è§„åˆ™å¼ºåˆ¶é‡å¯
--no-daemon ä»¥éå®ˆæŠ¤è¿›ç¨‹æ¨¡å¼å¯åŠ¨
å°ç»“ï¼š
ä¸Šé¢ä»‹ç»çš„è¿™äº›å¯åŠ¨å…¶å®æœ‰å¼Šç«¯ï¼š
1ã€é€šè¿‡å‘½ä»¤è¡Œä¼ é€’å‚æ•°ï¼Œæ— æ³•è®°ä½åˆ°åº•ä¼ é€’è¿‡å“ªäº›å‚æ•°ã€‚
2ã€å¯¹äºå¤šä¸ªè¿›ç¨‹ï¼Œä¸æ–¹ä¾¿ç®¡ç†ã€‚

[](https://blog.csdn.net/leonnew/article/details/121989900)

å¯åŠ¨
```bash
pm2 start app.js # å¯åŠ¨app.jsåº”ç”¨ç¨‹åº
pm2 start app.js -i 4 # cluster mode æ¨¡å¼å¯åŠ¨4ä¸ªapp.jsçš„åº”ç”¨å®ä¾‹
pm2 start app.js --name="api" # å¯åŠ¨åº”ç”¨ç¨‹åºå¹¶å‘½åä¸º "api"
pm2 start app.js --watch # å½“æ–‡ä»¶å˜åŒ–æ—¶è‡ªåŠ¨é‡å¯åº”ç”¨
pm2 start script.sh # å¯åŠ¨ bash è„šæœ¬
```

æŸ¥çœ‹ä¿¡æ¯
```
pm2 list # åˆ—è¡¨ PM2 å¯åŠ¨çš„æ‰€æœ‰çš„åº”ç”¨ç¨‹åº
pm2 monit # æ˜¾ç¤ºæ¯ä¸ªåº”ç”¨ç¨‹åºçš„CPUå’Œå†…å­˜å ç”¨æƒ…å†µ
pm2 show  id# æ˜¾ç¤ºåº”ç”¨ç¨‹åºçš„æ‰€æœ‰ä¿¡æ¯
pm2 logs # æ˜¾ç¤ºæ‰€æœ‰åº”ç”¨ç¨‹åºçš„æ—¥å¿—
pm2 logs id # æ˜¾ç¤ºæŒ‡å®šåº”ç”¨ç¨‹åºçš„æ—¥å¿—
```

åœæ­¢
```
pm2 stop all # åœæ­¢æ‰€æœ‰çš„åº”ç”¨ç¨‹åº
pm2 stop 0 # åœæ­¢ idä¸º 0çš„æŒ‡å®šåº”ç”¨ç¨‹åº
```

é‡å¯
```
pm2 restart all # é‡å¯æ‰€æœ‰åº”ç”¨
pm2 reload all # é‡å¯ cluster modeä¸‹çš„æ‰€æœ‰åº”ç”¨
```

åˆ é™¤åº”ç”¨
```
pm2 delete all # å…³é—­å¹¶åˆ é™¤æ‰€æœ‰åº”ç”¨
pm2 delete 0 # åˆ é™¤æŒ‡å®šåº”ç”¨ id 0
```

å…¶ä»–
```
pm2 gracefulReload all # Graceful reload all apps in cluster mode
pm2 scale api 10 # æŠŠåå­—å«apiçš„åº”ç”¨æ‰©å±•åˆ°10ä¸ªå®ä¾‹
pm2 reset [app-name] # é‡ç½®é‡å¯æ•°é‡
pm2 startup # åˆ›å»ºå¼€æœºè‡ªå¯åŠ¨å‘½ä»¤
pm2 save # ä¿å­˜å½“å‰åº”ç”¨åˆ—è¡¨
pm2 resurrect # é‡æ–°åŠ è½½ä¿å­˜çš„åº”ç”¨åˆ—è¡¨
pm2 update # Save processes, kill PM2 and restore processes
pm2 generate # Generate a sample json configuration file
pm2 start app.js --node-args="--max-old-space-size=1024"
```
é‡ç½®é‡å¯æ¬¡æ•°
pm2 reset  PID //ä¸€æ¬¡åªèƒ½é‡ç½®ä¸€ä¸ª
æŸ¥çœ‹ 

```
# æŸ¥çœ‹æ‰€æœ‰å·²å¯åŠ¨åº”ç”¨çš„åŸºæœ¬ä¿¡æ¯
# åŒ pm2 ls æˆ– pm2 status
pm2 list
 
# æŸ¥çœ‹æ‰€æœ‰åº”ç”¨çš„æ—¥å¿—ï¼ˆå†å² + å®æ—¶ï¼‰
pm2 logs
pm2 logs www # åªæŸ¥çœ‹åº”ç”¨ www çš„æ—¥å¿—
pm2 logs --lines 10 # æŸ¥çœ‹æœ€å10æ¡å†å²ï¼Œé»˜è®¤ 15 æ¡
pm2 logs --timestamp # å®æ—¶æ—¥å¿—æ·»åŠ æ—¶é—´å‰ç¼€
pm2 logs www --lines 10 --err # åªæŸ¥çœ‹åº”ç”¨ www çš„æœ€æ–° 10 æ¡é”™è¯¯æ—¥å¿—
pm2 flush # â—ï¸æ¸…ç©ºæ‰€æœ‰æ—¥å¿—æ–‡ä»¶
 
# æŸ¥çœ‹è¿›ç¨‹è¯¦æƒ…
pm2 show app_name|app_id
 
# æŸ¥çœ‹æ¯ä¸ªåº”ç”¨çš„CPUå’Œå†…å­˜èµ„æºå®æ—¶å ç”¨æƒ…å†µ
pm2 monit
 
# åœ¨çº¿çš„ Web è¯Šæ–­ç³»ç»Ÿï¼Œè·¨æœåŠ¡å™¨
# éœ€è¦æ³¨å†Œç™»å½•æˆ–ä½¿ç”¨ Githubã€Google è´¦æˆ·æˆæƒç™»å½•
pm2 monitor
```

 ç®¡ç†åº”ç”¨çŠ¶æ€

```
# é‡å¯ â—ï¸
# åŒæ—¶æ€æ­»å¹¶é‡å¯æ‰€æœ‰è¿›ç¨‹ï¼ŒçŸ­æ—¶é—´å†…æœåŠ¡ä¸å¯ç”¨ã€‚
# ç”Ÿæˆç¯å¢ƒæ¨èä½¿ç”¨ reload
pm2 restart app_id|app_name|all
 
# é‡è½½ ğŸ‘
# å§‹ç»ˆä¿æŒä¸€ä¸ªè¿›ç¨‹åœ¨çº¿ï¼Œé¿å…å®•æœº
pm2 reload app_id|app_name|all
 
# åœæ­¢
pm2 stop app_id|app_name|all
 
# å…³é—­å¹¶åˆ é™¤
pm2 delete app_id|app_name|all
 
# ç›´æ¥æ€æ­» pm2 å®ˆæŠ¤è¿›ç¨‹
pm2 kill
```

 é™æ€æœåŠ¡å™¨

```
# å°†ç›®å½• dist ä½œä¸ºé™æ€æœåŠ¡å™¨æ ¹ç›®å½•ï¼Œç«¯å£ä¸º 3333
pm2 serve ./dist 3333
 é›†ç¾¤æ¨¡å¼ï¼ˆè‡ªåŠ¨è´Ÿè½½å‡è¡¡ï¼‰

# max è¡¨ç¤º PM2 å°†è‡ªåŠ¨æ£€æµ‹å¯ç”¨ CPU çš„æ•°é‡å¹¶è¿è¡Œå°½å¯èƒ½å¤šçš„è¿›ç¨‹
# max å¯ä»¥è‡ªå®šä¹‰ï¼Œå¦‚æœæ˜¯ 4 æ ¸ CPUï¼Œè®¾ç½®ä¸º 2 åˆ™åªå ç”¨ 2 æ ¸
pm2 start app.js -i max
```
 å¼€æœºè‡ªå¯åŠ¨

```
pm2 startup
pm2 unstartup
```
 åº”ç”¨åˆ—è¡¨

```
# ä¿å­˜å½“å‰åº”ç”¨åˆ—è¡¨ï¼Œä»¥åå¯ä»¥æ¢å¤
pm2 save  # åŒ pm2 dump
 
# é‡æ–°åŠ è½½ä¹‹å‰ä¿å­˜çš„åº”ç”¨åˆ—è¡¨
pm2 resurrect
 
# æ¸…é™¤ä¿å­˜çš„åº”ç”¨åˆ—è¡¨
pm2 cleardump
```
 é…ç½®æ–‡ä»¶

ç”Ÿæˆç¤ºä¾‹é…ç½®æ–‡ä»¶

pm2 ecosystem # æˆ– pm2 init
ç¤ºä¾‹é…ç½®å¦‚ä¸‹ï¼ˆæ ¹æ®å®é™…é¡¹ç›®éœ€è¦æ·»åŠ ã€åˆ é™¤é…ç½®é¡¹ï¼‰

module.exports = {
  apps : [{
  name      : 'demo',      // åº”ç”¨å
  script    : 'app.js',   // åº”ç”¨æ–‡ä»¶ä½ç½®
  env: {
    PM2_SERVE_PATH: ".",    // é™æ€æœåŠ¡è·¯å¾„
    PM2_SERVE_PORT: 8080,   // é™æ€æœåŠ¡å™¨è®¿é—®ç«¯å£
    NODE_ENV: 'development' // è®¾ç½®å¼€å‘ç¯å¢ƒè¿è¡Œæ—¶
  },
  env_production : {
    NODE_ENV: 'production'  // è®¾ç½®ç”Ÿäº§ç¯å¢ƒè¿è¡Œæ—¶
  },
  instances: "max",         // å°†åº”ç”¨ç¨‹åºåˆ†å¸ƒåœ¨æ‰€æœ‰CPUæ ¸å¿ƒä¸Š,å¯ä»¥æ˜¯æ•´æ•°æˆ–è´Ÿæ•°
  watch: true,              // ç›‘å¬æ¨¡å¼
  output: './out.log',      // æŒ‡å®šæ—¥å¿—æ ‡å‡†è¾“å‡ºæ–‡ä»¶åŠä½ç½®
  error: './error.log',     // é”™è¯¯è¾“å‡ºæ—¥å¿—æ–‡ä»¶åŠä½ç½®
  merge_logs: true,         // é›†ç¾¤æƒ…å†µä¸‹ï¼Œå¯ä»¥åˆå¹¶æ—¥å¿—
  log_type: "json",         // æ—¥å¿—ç±»å‹
  log_date_format: "DD-MM-YYYY",  // æ—¥å¿—çš„æ—¥æœŸæ ¼å¼
  }],
  deploy : {
    production : {
      user : 'SSH_USERNAME',
      host : 'SSH_HOSTMACHINE',
      ref  : 'origin/master',
      repo : 'GIT_REPOSITORY',
      path : 'DESTINATION_PATH',
      'pre-deploy-local': '',
      'post-deploy' : 'npm install && pm2 reload ecosystem.config.js --env production',
      'pre-setup': ''
    }
  }
}

ä»¥é…ç½®æ–‡ä»¶å¯åŠ¨ç¤ºä¾‹

pm2 start ecosystem.config.js --env production
âš ï¸ æ³¨æ„ï¼šé…ç½®æ–‡ä»¶æ”¯æŒ js å’Œ yaml æ ¼å¼ï¼Œè¿˜æœ‰ä¸€äº›æ²¡æœ‰åˆ—ä¸¾çš„å‚æ•°é¡¹ï¼Œè¯¦è§å®˜æ–¹æ–‡æ¡£ï¼šhttps://pm2.keymetrics.io/docs/usage/application-declaration
 
 å‡çº§ PM2

# æ›´æ–°å‰æ¨èå…ˆä¿å­˜å½“å‰åº”ç”¨åˆ—è¡¨ï¼Œæ–¹ä¾¿æ›´æ–°åç›´æ¥æ¢å¤
pm2 save
 
# æ›´æ–°ä¸»ç¨‹åº
npm install pm2 -g
 
# ç´§æ¥ç€æ›´æ–°å†…å­˜ä¸­çš„ç¨‹åº
pm2 update
 
# æ¢å¤åº”ç”¨åˆ—è¡¨
pm2 resurrect
 æ—¥å¿—åˆ‡å‰²

å®‰è£… pm2-logrotate-ext æ‰©å±•æ¨¡å—

é¡¹ç›®åœ°å€ï¼šhttps://github.com/Lujo5/pm2-logrotate-ext

pm2 install pm2-logrotate-ext
é‡æ–°å¯åŠ¨åº”ç”¨åï¼Œpm2-logrotate-ext ä»¥æ¨¡å—çš„å½¢å¼è¢«åŠ è½½ã€å¯åŠ¨ã€‚

å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤å¯¹å…¶é…ç½®è¿›è¡Œä¿®æ”¹ï¼š

# å½“æ–‡ä»¶å¤§å°è¶…è¿‡æ­¤è®¾ç½®åˆ™æ‰§è¡Œåˆ‡å‰²
pm2 set pm2-logrotate-ext:max_size 1M
 
# ä¿ç•™æœ€æ–°çš„å‡ ä¸ªæ—¥å¿—æ–‡ä»¶
pm2 set pm2-logrotate-ext:retain 30
 
# æ˜¯å¦å¼€å¯ gzip å‹ç¼©
pm2 set pm2-logrotate-ext:compress false
 
# æ–‡ä»¶åçš„æ—¥æœŸéƒ¨åˆ†æ ¼å¼
pm2 set pm2-logrotate-ext:dateFormat YYYY-MM-DD_HH-mm-ss
 
# å‡ ç§’é’Ÿæ£€æŸ¥ä¸€æ¬¡æ—¥å¿—æ–‡ä»¶å¤§å°
pm2 set pm2-logrotate-ext:workerInterval 30
 
# ç±»ä¼¼äºç³»ç»Ÿçš„å®šæ—¶ä»»åŠ¡ï¼Œå½“æ»¡è¶³æŒ‡å®šè§„åˆ™æ—¶ï¼Œ
# ä¸ç®¡æ—¥å¿—æ–‡ä»¶å¤§å°æ˜¯å¦è¾¾åˆ°è®¾ç½®çš„æœ€å¤§å€¼ï¼Œç›´æ¥å¯¹æ—¥å¿—æ–‡ä»¶è¿›è¡Œåˆ‡å‰²
pm2 set pm2-logrotate-ext:rotateInterval 0 0 * * *
 
# å¯¹ pm2 æ¨¡å—äº§ç”Ÿçš„æ—¥å¿—åŒæ ·è¿›è¡Œåˆ‡å‰²å¤„ç†
pm2 set pm2-logrotate-ext:rotateModule true
 
# æ˜¯å¦æŒ‰å®šæ—¶ä»»åŠ¡è®¾ç½®è§„åˆ™å¼ºåˆ¶æ‰§è¡Œ
# å¦‚æœè®¾ç½®ä¸ºå¦ï¼Œåˆ™åªæœ‰å½“æ—¥å¿—æ–‡ä»¶å¤§å°è¶…è¿‡è®¾ç½®æ—¶æ‰è¿›è¡Œåˆ‡å‰²
pm2 set pm2-logrotate-ext:forced true
